---
layout: post
title:  "PatchELF"
date:   2020-10-04
categories: ["2020","pwnable","tips"]
update:   2020-10-04
comment: true
tags: [pwnable,tips]
---

ë˜ë¦¼í•µ ë¬¸ì œë¥¼ í’€ë‹¤ê°€ `rtld_global_overwrite`ë¥¼ í•  ì¼ì´ ìƒê²¼ë‹¤. ë‚˜ëŠ” Ubuntu 18.04ë¥¼ ì“°ê³  ìˆì—ˆê³  ì„œë²„ëŠ” Ubuntu 16.04ë¥¼ ì“°ê³  ìˆì—ˆë‹¤. ì´ ë•Œê¹Œì§€ í‘¼ ë¬¸ì œë“¤ì€ libc base ë¦­ í•œ ë‹¤ìŒ í•¨ìˆ˜ ì£¼ì†Œë“¤ ì“°ë©´ ëì—ˆëŠ”ë°, ì´ ë²ˆì—ëŠ” ë¡œë”ì— ìˆëŠ” `_rtld_global`ì„ ì“°ë ¤ê³  í•´ì„œì¸ì§€ ì„¸íŒ…ì„ ì •í™•íˆ ë§ì¶°ì£¼ì§€ ì•Šìœ¼ë‹ˆê¹Œ offsetì´ ê³„ì† ë‹¤ë¥´ë‹¤.. ê·¼ë° `WSL2`ì—ëŠ” Ubuntu 16.04ê°€ ì—†ì–´ì„œ **patchelf**ë¥¼ ì¨ì„œ libcì™€ ldë¥¼ ë‘˜ë‹¤ ë§í‚¹í•´ì£¼ê¸°ë¡œ í–ˆë‹¤.

### Installing PatchELF 

**in WSL2**

```sh
$ sudo apt-get install libtool
$ sudo apt-get install autoconf
$ wget http://nixos.org/releases/patchelf/patchelf-0.10/patchelf-0.10.tar.bz2
$ tar xf patchelf-0.10.tar.bz2
$ cd patchelf-0.10
$ ./configure --prefix="/usr" 
$ make install
$ strip --strip-unneeded ~/.local/bin/patchelf
$ gzip -9 ~/.local/share/man/man1/patchelf.1
```

`sudo apt-get install patchelf`ë¡œ ì„¤ì¹˜í•˜ë©´ 0.9ë²„ì „ì´ ì„¤ì¹˜ê°€ ë˜ëŠ”ë°, 0.9ë²„ì „ì€ ì—ëŸ¬ê°€ ìˆì–´ì„œ 0.10ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜í•œë‹¤.

ì²˜ìŒì—ëŠ” `./configure --prefix="/usr" `ê°€ ì•„ë‹ˆë¼ `./configure --prefix="$HOME/.local"`ì˜€ëŠ”ë° `/usr/bin/patchelf`ë¥¼ ì¸ì‹ì„ ëª»í•´ì„œ ì‹¤í–‰ì„ ëª»í–ˆë‹¤. ê·¸ë˜ì„œ ê²½ë¡œë¥¼ ë°”ê¿”ì¤¬ë‹¤.

### Linking libc & ld

ìƒˆë¡œìš´ libcë¥¼ ë§í‚¹í•´ì¤€ë‹¤.

``` sh
$ patchelf --replace-needed LIBRARY NEW_LIBRARY path/to/FILENAME
```

ìƒˆë¡œìš´ ldë„ ë§í‚¹í•´ì¤€ë‹¤.

```sh
$ patchelf --set-interpreter NEw_LD path/to/FILENAME
```

ì´ ë•Œ ì£¼ì–´ì§„ libcì— ë§ëŠ” ldë¥¼ ì„ íƒí•´ì„œ ë§í‚¹í•´ì¤˜ì•¼ í•œë‹¤.

[https://github.com/matrix1001/welpwn/tree/master/PwnContext/libs/ld.so](https://github.com/matrix1001/welpwn/tree/master/PwnContext/libs/ld.so)

libc md5 hashì— ë§ëŠ” ld íŒŒì¼ë“¤ì„ ì œê³µí•´ì¤€ë‹¤. libc md5 hashê°’ì´ 8c0d248ea33e6ef17b759fa5d81dda9e ë¼ë©´ `ld-8c0d248ea33e6ef17b759fa5d81dda9e.so.2`ë¥¼ ë‹¤ìš´ë°›ì•„ì„œ ìƒˆë¡œìš´ ldë¡œ ì§€ì •í•´ì£¼ë©´ ë˜ëŠ” ê²ƒì´ë‹¤.

![image](https://user-images.githubusercontent.com/51329156/94995679-d638fb00-05da-11eb-8952-3eac475d5c53.png)

ì˜ ë°”ë€ ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤! êµ³ì´ 16.04í™˜ê²½ì„ ì•ˆ ì“°ë”ë¼ë„ ì´ë ‡ê²Œ í•  ìˆ˜ë„ ìˆë‹¤ !ğŸ‘